{% extends "./base.html" %}
{% load static %}

{% block title %}Αίτηση ΕΣΥΔ{% endblock %}

{% block head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/esydApp.css' %}">

{% endblock %}

{% block page_content %}
    <div class="content_application">
        <div class="pending_list">
            <h2 class="ml-3">Αιτήσεις σε εκκρεμότητα:</h2>
            {% if pendingApps %}
            <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Αρ. Αίτησης</th>
                        <th scope="col">Κατάσταση</th>
                        <th scope="col">Ημερομηνία Υποβολής</th>
                        {% if user.is_esyd %}
                        <th scope="col">Αρχείο</th>
                        <th scope="col">Υποβλήθηκε από</th>
                        {% endif %}                        
                    </tr>
                </thead>
            <tbody>
                {% for pendApp in pendingApps%}
                    <tr class="accordion-toggle collapsed" id="accordion1" data-toggle="collapse" data-parent="#accordion1" href="#id{{ pendApp.id }}">
                        <td class="expand-button"></td>
                        <td>{{ pendApp.id }}</td>
                        <td>{{ pendApp.status }}</td>
                        <td>{{ pendApp.date }}</td>
                        {% if user.is_esyd %}
                        <td>
                        {% with myFilter="esyd_applications/"|add:pendApp.foreas.foreas_profile.companyName|add:'/' %}
                            {{ pendApp.file.name|cut:myFilter }}
                        {% endwith %}                            
                        <a onclick="window.open('{{ pendApp.file.url }}', '_blank');" class="btn btn-info ml-3" >View</a></td>
                        <td>{{ pendApp.foreas.foreas_profile.companyName }} (ΑΦΜ: {{ pendApp.foreas.foreas_profile.afm }})</td>
                        {% endif %} 
                    </tr>
                    <tr class="hide-table-padding">
                        <td></td>
                        <td colspan="5">
                            <div id="id{{ pendApp.id }}" class="collapse in p-3">
                                <div class="row">
                                    <div class="col"><b>Πεδίο</b></div>
                                    <div class="col"><b>Κατάσταση</b></div>
                                    <div class="col"><b>Ημερομηνία Λήξης</b></div>
                                </div>
                                {% for field in pendApp.children.all %}                                    
                                    <div class="row border-top mt-3">
                                        <div class="col"> {{ field.subField }}</div>
                                        {% if field.status == 'Σε εκκρεμότητα' %}
                                            <div class="col text-primary"> {{ field.status }}</div>
                                        {% elif field.status == 'Απορρίφθηκε' %}
                                            <div class="col text-danger"> {{ field.status }}</div>
                                        {% elif field.status == 'Εγκρίθηκε' %}
                                            <div class="col text-success"> {{ field.status }}</div> 
                                        {% endif %}                                                                                      
                                        <div class="col"> {{ field.expDate }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
            </table>
            </div>
            {% else %}
                <h4 class="ml-3">Δεν υπάρχουν αιτήσεις σε εκκρεμότητα</h4>
            {% endif %}
            
        </div>
        <br>
        <br>
        <br>
        {% if user.is_foreas %}
        <div class="upload_app">
            <h2 class="ml-3">Αίτηση νέου πιστοποιητικού διαπίστευσης (ΕΣΥΔ):</h2>
            </br>
            <form method="post" enctype="multipart/form-data" action="">
            {% csrf_token %}
                {{ form.as_p }}
            </br>
                <button type="submit" value="save" class="btn btn-info ml-3">Καταχώρηση</button>
            </form>

            {% if uploaded_file_url %}
             <p>File uploaded at: <a href="{{ uploaded_file_url }}">{{ uploaded_file_url }}</a></p>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.18.0/js/mdb.min.js"></script>
{% endblock %}