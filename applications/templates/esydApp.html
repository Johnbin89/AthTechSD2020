{% extends "./base.html" %}
{% load static %}
{% load extra_tags %}

{% block title %}Αίτηση ΕΣΥΔ{% endblock %}

{% block head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/esydApp.css' %}">

{% endblock %}

{% block page_content %}
    <div class="content_application">
        <div class="pending_list">
            <h2 class="ml-3">Αιτήσεις σε εκκρεμότητα:</h2>
            {% if pendingApps %}
            <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Αρ. Αίτησης</th>
                        <th scope="col">Κατάσταση</th>
                        <th scope="col">Ημερομηνία Υποβολής</th>
                        {% if user.is_esyd %}
                        <th scope="col">Αρχείο</th>
                        <th scope="col">Υποβλήθηκε από</th>
                        {% endif %}                        
                    </tr>
                </thead>
            <tbody>
                {% for pendApp in pendingApps%}
                    <tr class="accordion-toggle collapsed" id="accordion1" data-toggle="collapse" data-parent="#accordion1" href="#id{{ pendApp.id }}">
                        <td class="expand-button"></td>
                        <td>{{ pendApp.id }}</td>
                        <td>{{ pendApp.status }}</td>
                        <td>{{ pendApp.date }}</td>
                        {% if user.is_esyd %}
                        <td>
                        {% with myFilter="esyd_applications/"|add:pendApp.foreas.foreas_profile.companyName|add:'/' %}
                            {{ pendApp.file.name|cut:myFilter }}
                        {% endwith %}                            
                        <a onclick="window.open('{{ pendApp.file.url }}', '_blank');" class="btn btn-info ml-3" >View</a></td>
                        <td>{{ pendApp.foreas.foreas_profile.companyName }} (ΑΦΜ: {{ pendApp.foreas.foreas_profile.afm }})</td>
                        {% endif %} 
                    </tr>
                    <tr class="hide-table-padding">
                        <td></td>
                        <td colspan="5">
                            <div id="id{{ pendApp.id }}" class="collapse in p-3">
                                <div class="row">
                                    <div class="col"><b>Πεδίο</b></div>
                                    <div class="col"><b>Κατάσταση</b></div>
                                    <div class="col"><b>Ημερομηνία Λήξης</b></div>
                                    {% if user.is_esyd %}
                                    <div class="col"><b>Αποθήκευση</b></div>
                                    {% endif %}
                                </div>
                                {% if user.is_esyd %}
                                <form>
                                {% for field in pendApp.children.all %}
                                {% with form_name="form"|addstr:pendApp.id|addstr:field.subField|cut:" " %}
                                {% with form=status_forms|get_item:form_name %}                                                                   
                                    <div class="row border-top mt-3">
                                        <div class="col"> {{ field.subField }}</div>
                                        
                                        <div class="col">{{ form.status }}</div>                                                                                    
                                        <div class="col"> {{ form.expDate }}</div>
                                        <div class="col">
                                        <button onclick="cancelSave('{{form_name}}')" type="reset" class="btn btn-sm btn-danger hidden" data-testid="{{form_name}}"  id="cancel-{{form_name}}" value="Cancel">Cancel</button>
                                        <button onclick="editSubfield('{{form_name}}')" type="button" class="btn btn-sm btn-warning" data-testid="{{form_name}}"  id="edit-{{form_name}}">Edit</button>
                                        <button onclick="saveSubfield('{{form_name}}')" type="button" class="btn btn-sm btn-info" disabled="True" data-testid="{{form_name}}"  id="save-{{form_name}}">Save</button>                  
                                        <button onclick="confirmSave('{{form_name}}','{{field.id}}','{{field.subField}}')" type="button" class="btn btn-sm btn-primary hidden" data-testid="{{form_name}}"  id="confirm-{{form_name}}">Confirm</button>
                                        
                                        </div>
                                    </div>
                                {% endwith %}
                                {% endwith %}
                                {% endfor %}
                                </form>
                                {% endif %}


                                {% if user.is_foreas %}

                                {% for field in pendApp.children.all %}                                    
                                <div class="row border-top mt-3">
                                    <div class="col"> {{ field.subField }}</div>
                                    {% if field.status == 'Σε εκκρεμότητα' %}
                                        <div class="col text-primary"> {{ field.status }}</div>
                                    {% elif field.status == 'Απορρίφθηκε' %}
                                        <div class="col text-danger"> {{ field.status }}</div>
                                    {% elif field.status == 'Εγκρίθηκε' %}
                                        <div class="col text-success"> {{ field.status }}</div> 
                                    {% endif %}                                                                                      
                                    <div class="col"> {{ field.expDate }}</div>
                                </div>
                                {% endfor %}

                                {% endif %} 
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
            </table>
            </div>
            {% else %}
                <h4 class="ml-3">Δεν υπάρχουν αιτήσεις σε εκκρεμότητα</h4>
            {% endif %}
            
        </div>
        <br>
        <br>
        <br>
        {% if user.is_foreas %}
        <div class="upload_app">
            <h2 class="ml-3">Αίτηση νέου πιστοποιητικού διαπίστευσης (ΕΣΥΔ):</h2>
            </br>
            <form method="post" enctype="multipart/form-data" action="">
            {% csrf_token %}
                {{ form.as_p }}
            </br>
                <button type="submit" value="save" class="btn btn-info ml-3">Καταχώρηση</button>
            </form>

            {% if uploaded_file_url %}
             <p>File uploaded at: <a href="{{ uploaded_file_url }}">{{ uploaded_file_url }}</a></p>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">


function editSubfield(form_name){
    var saveBtn = $(`#save-${form_name}`)
    var cancelBtn = $(`#cancel-${form_name}`)
    var confirmBtn = $(`#confirm-${form_name}`)
    var editBtn = $(`#edit-${form_name}`)
    var status_field = $(`#status-${form_name}`)
    var date_field = $(`#expDate-${form_name}`)
    saveBtn.prop('disabled', false)
    cancelBtn.removeClass('hidden')
    status_field.prop('disabled', false)
    date_field.prop('disabled', false)

}

function saveSubfield(form_name){
        var saveBtn = $(`#save-${form_name}`)
        var cancelBtn = $(`#cancel-${form_name}`)
        var confirmBtn = $(`#confirm-${form_name}`)
        var editBtn = $(`#edit-${form_name}`)
        var status_field = $(`#status-${form_name}`)
        var date_field = $(`#expDate-${form_name}`)

        saveBtn.addClass('hidden')

        cancelBtn.removeClass('hidden')
        confirmBtn.removeClass('hidden')
}


function cancelSave(form_name){

        var saveBtn = $(`#save-${form_name}`)
        var cancelBtn = $(`#cancel-${form_name}`)
        var confirmBtn = $(`#confirm-${form_name}`)
        var status_field = $(`#status-${form_name}`)
        var date_field = $(`#expDate-${form_name}`)
        saveBtn.removeClass('hidden')
        saveBtn.prop('disabled', true)
        cancelBtn.addClass('hidden')
        confirmBtn.addClass('hidden')
        status_field.prop('disabled', true)
        date_field.prop('disabled', true)

}


function confirmSave(form_name, field_id, field_name){
        console.log('Saved!')
        var testid = $(this).data('testid')
        var saveBtn = $(`#save-${form_name}`)
        var cancelBtn = $(`#cancel-${form_name}`)
        var confirmBtn = $(`#confirm-${form_name}`)

        saveBtn.removeClass('hidden')

        cancelBtn.addClass('hidden')
        confirmBtn.addClass('hidden')
        var status = $(`#status-${form_name}`).val()
        var date = $(`#expDate-${form_name}`).val()
        var data = {'status':status, 'date':date, 'application_id':form_name[4] , 'field_id':field_id, 'field_name':field_name}
        console.log(data)
        updateSubfieldPOST(data)

}

function updateSubfieldPOST(data){
        var url = "{% url 'esyd_update_subfield' %}"
        $.ajax({
            method:'POST',
            url:url,
            data:data,
            success:function(){
                window.location.href = "{% url 'esyd_xeiristis' %}"
            }
        })
    }

</script>
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.18.0/js/mdb.min.js"></script>
{% endblock %}